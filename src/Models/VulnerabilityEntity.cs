using MongoDB.Bson;
using MongoDB.Bson.Serialization.Attributes;
using TrueSecProject.Models; // For the SpecVersion enum

namespace TrueSecProject.Data
{
    /// <summary>
    /// Represents a Vulnerability document in the MongoDB database.
    /// </summary>
    public class VulnerabilityEntity
    {
        // StixObject Properties
        [BsonId]
        [BsonRepresentation(BsonType.String)]
        public string Id { get; set; } = null!;

        [BsonElement("type")]
        public string Type { get; set; } = "vulnerability";

        [BsonElement("spec_version")]
        [BsonRepresentation(BsonType.String)]
        public SpecVersion SpecVersion { get; set; }

        [BsonElement("created_by_ref")]
        [BsonIgnoreIfNull]
        public string? CreatedByRef { get; set; }

        [BsonElement("labels")]
        [BsonIgnoreIfNull]
        public List<string>? Labels { get; set; }

        [BsonElement("created")]
        public DateTime Created { get; set; }

        [BsonElement("modified")]
        public DateTime Modified { get; set; }

        [BsonElement("revoked")]
        [BsonIgnoreIfNull]
        public bool? Revoked { get; set; }

        [BsonElement("confidence")]
        [BsonIgnoreIfNull]
        public int? Confidence { get; set; }

        [BsonElement("lang")]
        [BsonIgnoreIfNull]
        public string? Lang { get; set; }

        [BsonElement("external_references")]
        [BsonIgnoreIfNull]
        public List<ExternalReferenceEntity>? ExternalReferences { get; set; }

        [BsonElement("object_marking_refs")]
        [BsonIgnoreIfNull]
        public List<string>? ObjectMarkingRefs { get; set; }

        [BsonElement("granular_markings")]
        [BsonIgnoreIfNull]
        public List<GranularMarkingEntity>? GranularMarkings { get; set; }

        // Vulnerability Specific Properties
        [BsonElement("name")]
        public string Name { get; set; } = null!;

        [BsonElement("description")]
        [BsonIgnoreIfNull]
        public string? Description { get; set; }
    }

    /// <summary>
    /// Represents a nested External Reference document.
    /// </summary>
    public class ExternalReferenceEntity
    {
        [BsonElement("source_name")]
        public string SourceName { get; set; } = null!;

        [BsonElement("description")]
        [BsonIgnoreIfNull]
        public string? Description { get; set; }

        [BsonElement("hashes")]
        [BsonIgnoreIfNull]
        public Dictionary<string, string>? Hashes { get; set; }

        [BsonElement("url")]
        [BsonIgnoreIfNull]
        public string? Url { get; set; }

        [BsonElement("external_id")]
        [BsonIgnoreIfNull]
        public string? ExternalId { get; set; }
    }

    /// <summary>
    /// Represents a nested Granular Marking document.
    /// </summary>
    public class GranularMarkingEntity
    {
        [BsonElement("lang")]
        [BsonIgnoreIfNull]
        public string? Lang { get; set; }

        [BsonElement("marking_ref")]
        [BsonIgnoreIfNull]
        public string? MarkingRef { get; set; }

        [BsonElement("selectors")]
        public List<string> Selectors { get; set; } = new();
    }
}